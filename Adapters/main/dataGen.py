import json
import os
import sys
import optparse
import threading
import time

from sumolib import checkBinary
import traci
import paho.mqtt.client as mqtt


def on_connect(client, userdata, flags, rc):
    print(f"Conectado ao broker com código de resultado {rc}")


def on_publish(client, userdata, mid):
    print(f"Mensagem publicada com sucesso")


def on_message(client, userdata, msg):
    print(f"Received `{msg.payload.decode()}` from `{msg.topic}` topic")


if __name__ == "__main__":
    # Inicia a conexão MQTT
    mqtt_client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION1)
    mqtt_client.on_connect = on_connect
    mqtt_client.on_publish = on_publish
    mqtt_client.on_message = on_message
    mqtt_client.connect("localhost", 1883, 60)
    mqtt_client.loop_start()  # Inicia o loop de eventos MQTT em uma thread separada

    coordenadas = [
        {"lat": 40.6361250091032, "lng": -8.659596064875444},
        {"lat": 40.63614421690061, "lng": -8.659584022192302},
        {"lat": 40.63617451402699, "lng": -8.659565026833864},
        {"lat": 40.63621796381109, "lng": -8.659537747677366},
        {"lat": 40.636280362615636, "lng": -8.6594983934419},
        {"lat": 40.63635442498533, "lng": -8.659451569633564},
        {"lat": 40.636445762348984, "lng": -8.65939350430772},
        {"lat": 40.636548697617705, "lng": -8.659328563126143},
        {"lat": 40.636663397520344, "lng": -8.659257355031114},
        {"lat": 40.63677383776296, "lng": -8.659189109605107},
        {"lat": 40.63688392296575, "lng": -8.659121026816775},
        {"lat": 40.636996428455866, "lng": -8.659051446928977},
        {"lat": 40.637109249752726, "lng": -8.65898167146447},
        {"lat": 40.63722340802476, "lng": -8.658911068865555},
        {"lat": 40.637333804417715, "lng": -8.658842792590345},
        {"lat": 40.637449686271246, "lng": -8.658771123479337},
        {"lat": 40.63756888953621, "lng": -8.658697399894125},
        {"lat": 40.63828, "lng": -8.657928} # Final

    ]

    simple_coordenadas = [
        {"lat": 40.62955412568942, "lng": -8.659948357034295},
        {"lat": 40.62956698224956, "lng": -8.659965421719296},
        {"lat": 40.629592219020324, "lng": -8.65999891885296},
        {"lat": 40.629633723480545, "lng": -8.660053853400987},
        {"lat": 40.629686126961516, "lng": -8.660123366574778},
        {"lat": 40.62974751404588, "lng": -8.66020488321566},
        {"lat": 40.62981954096604, "lng": -8.660300528909177},
        {"lat": 40.62990208274352, "lng": -8.66041013783126},
        {"lat": 40.629987655850194, "lng": -8.660523772548647},
        {"lat": 40.630075512476864, "lng": -8.66064044006712},
        {"lat": 40.63016570419759, "lng": -8.660760208909966},
        {"lat": 40.63025117518078, "lng": -8.660873709364754},
        {"lat": 40.630340734915706, "lng": -8.660992639911802},
        {"lat": 40.630428620658925, "lng": -8.661109347954424},
        {"lat": 40.630514568949756, "lng": -8.66122325482653},
        {"lat": 40.63061394306043, "lng": -8.66132289326126},
        {"lat": 40.63071215402033, "lng": -8.6614213658264},
        {"lat": 40.630809116305485, "lng": -8.661518586756474},
        {"lat": 40.63092175465062, "lng": -8.661608306366183},
        {"lat": 40.63103458408099, "lng": -8.66167761596516},
        {"lat": 40.63115523756565, "lng": -8.661749113512915},
        {"lat": 40.63127460437968, "lng": -8.66180949458963},
        {"lat": 40.63139870901823, "lng": -8.661852140645298},
        {"lat": 40.631523824390264, "lng": -8.661894569238518},
        {"lat": 40.63165175109462, "lng": -8.661902502813552},
        {"lat": 40.63177596296334, "lng": -8.661910206034797},
        {"lat": 40.63189721253265, "lng": -8.661887486800033},
        {"lat": 40.63202006331324, "lng": -8.661861170057344},
        {"lat": 40.63214622052021, "lng": -8.661830444841781},
        {"lat": 40.63226403885954, "lng": -8.661781197000453},
        {"lat": 40.63238596682815, "lng": -8.66173023114767},
        {"lat": 40.63251041421443, "lng": -8.661678211975339},
        {"lat": 40.632627053008385, "lng": -8.661629456618085},
        {"lat": 40.63274379981707, "lng": -8.661580655929301},
        {"lat": 40.63286124215754, "lng": -8.661531564322342},
        {"lat": 40.632984074074265, "lng": -8.661480219643874},
        {"lat": 40.63310827427907, "lng": -8.661428064270812},
        {"lat": 40.63323220293694, "lng": -8.661375258799591},
        {"lat": 40.63334843228209, "lng": -8.66132573378318},
        {"lat": 40.6334733168739, "lng": -8.661272520584747},
        {"lat": 40.633588906658424, "lng": -8.661207717358995},
        {"lat": 40.63370557374996, "lng": -8.661132548993084},
        {"lat": 40.63381779270637, "lng": -8.66106029852419},
        {"lat": 40.63393684125975, "lng": -8.660983641803915},
        {"lat": 40.63405264525627, "lng": -8.660909073994798},
        {"lat": 40.63416430323172, "lng": -8.660837175590096},
        {"lat": 40.63427646977302, "lng": -8.660764949438285},
        {"lat": 40.634388369243645, "lng": -8.66069289498544},
        {"lat": 40.63449748975728, "lng": -8.66062262969974},
        {"lat": 40.63461341703682, "lng": -8.660547981092167},
        {"lat": 40.63472431676326, "lng": -8.660476569583778},
        {"lat": 40.63484258787927, "lng": -8.660400412002334},
        {"lat": 40.63495508789388, "lng": -8.660329685572036},
        {"lat": 40.63507401294292, "lng": -8.66025511888434},
        {"lat": 40.635190045195976, "lng": -8.660182365708968},
        {"lat": 40.635299779780794, "lng": -8.660113560962149},
        {"lat": 40.63541769652567, "lng": -8.660039625631384},
        {"lat": 40.63552880060569, "lng": -8.65996996166179},
        {"lat": 40.63564194879872, "lng": -8.659899015734396},
        {"lat": 40.63575673317792, "lng": -8.659827037455935},
        {"lat": 40.635870587125396, "lng": -8.659755626608305},
        {"lat": 40.635987285406934, "lng": -8.65968243146938},
        {"lat": 40.63610641212498, "lng": -8.659607702786433}
    ]

    # For Aveiro Map
    # for coordenada in coordenadas:

    #     data = {
    #         "vehicle": "VEICULOTEST",
    #         "data": {
    #             "location": {
    #                 "lat": coordenada["lat"],
    #                 "lng": coordenada["lng"]
    #             },
    #             "speed": 43
    #         }
    #     }


    # For Simple Map
    for coordenada in simple_coordenadas:
        data = {
            "vehicle": "VEICULOTEST",
            "data": {
                "location": {
                    "lat": coordenada["lat"],
                    "lng": coordenada["lng"]
                },
                "speed": 43
            }
        }

        payload = json.dumps(data)
        mqtt_client.publish("/teste", payload)
        time.sleep(0.8)

